sudo: required
dist: trusty
language: generic

services:
  - docker

cache:
  directories:
    - $HOME/.composer/cache/files


env:
  matrix:
    - PHP_VERSION=5.6 VARNISH_VERSION=4.1 VARNISH_MODULES_VERSION=0.10.2 COMPOSER_FLAGS="--prefer-lowest"
    - PHP_VERSION=7.0 VARNISH_VERSION=5.0
    - PHP_VERSION=7.1 DOCCHECK=true DEPENDENCIES="symfony/lts:^2"
    - PHP_VERSION=7.2
    #- PHP_VERSION=7.2 STABILITY="dev"

branches:
  only:
    - master
    # Build maintenance branches for older releases if needed. such branches should be named like "1.2"
    - '/^\d+\.\d+$/'

# For local dev, remember to append --build if you have done changes to docker config or want to change php/varnish versions.
install: docker-compose up -d


before_script:
  - if [ "$STABILITY" != "" ]; then docker-compose exec fos sh -c "composer config minimum-stability ${STABILITY}"; fi;
  - if [ "$DEPENDENCIES" != "" ]; then docker-compose exec fos sh -c "composer require --no-update ${DEPENDENCIES}"; fi;
  - docker-compose exec fos sh -c "composer update $COMPOSER_FLAGS --prefer-dist --no-interaction"
  - if [ "$DOCCHECK" = true ]; then docker-compose exec fos sh -c "pip install -r doc/requirements.txt"; fi;

script:
  - docker-compose exec fos sh -c "composer validate --strict --no-check-lock"
  - docker-compose exec fos sh -c "vendor/bin/phpunit $PHPUNIT_FLAGS"
  - if [ "$DOCCHECK" = true ]; then docker-compose exec fos sh -c "make -C doc SPHINXOPTS='-nW' html"; fi;
  - if [ "$DOCCHECK" = true ]; then docker-compose exec fos sh -c "make -C doc spelling"; fi;

#after_script:
  # Todo fix to use curl in image, and either install xdebug OR change to use phpdbg, then re add $PHPUNIT_FLAGS usage
  #- wget https://scrutinizer-ci.com/ocular.phar && php ocular.phar code-coverage:upload --format=php-clover coverage.clover

after_failure:
  # Will show us the last bit of the log of container's main processes
  # NOTE: errors during docker setup of travis build might not show up here (can't output all as it is too much in debug/verbose mode)
  - docker-compose logs -t --tail=25
  # Will show us what is up, and how long it's been up
  - docker ps -s
