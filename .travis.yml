sudo: required
dist: trusty
group: edge
language: php
cache:
  directories:
    - $HOME/.composer/cache/files

services:
  - docker

php:
  - 5.6
  - 7.0
  - 7.1

env:
  - DOCKER_IMAGE="friendsofsymfony/http-cache-ci:php-${TRAVIS_PHP_VERSION}"

matrix:
  include:
    - php: 5.6
      env: SYMFONY_VERSION=2.7.* VARNISH_VERSION=3.0.0 COMPOSER_FLAGS="--prefer-lowest"
    - php: 7.0
      env: VARNISH_VERSION=4.1.5 DOCCHECK=true

branches:
  only:
    - master
    # Build maintenance branches for older releases if needed. such branches should be named like "1.2"
    - '/^\d+\.\d+$/'

before_script:
  - env > docker/.env
  - docker build --build-arg PHP_VERSION=$TRAVIS_PHP_VERSION -t $DOCKER_IMAGE docker/
  - sudo apt-get install -qq python-sphinx enchant
  - sudo pip install -r doc/requirements.txt

script:
#  - docker run -v `pwd`:/app "friendsofsymfony/http-cache-ci:php-${TRAVIS_PHP_VERSION}" sh -c "varnishd -f /app/tests/Functional/Fixtures/varnish/fos.vcl -p vcl_dir=/app/tests/Functional/Fixtures/varnish/"
  - docker run --rm -v `pwd`:/app $DOCKER_IMAGE sh -c "composer update $COMPOSER_FLAGS --prefer-source --no-interaction && vendor/bin/phpunit --coverage-clover=coverage.clover"
  - if [[ "$DOCCHECK" = true ]]; then make -C doc SPHINXOPTS='-nW' html; fi
  - if [[ "$DOCCHECK" = true ]]; then make -C doc spelling; fi

after_script:
  - wget https://scrutinizer-ci.com/ocular.phar && php ocular.phar code-coverage:upload --format=php-clover coverage.clover

after_failure:
  - cat /tmp/fos_nginx_error.log
  - cat /tmp/fos_nginx_access.log
  - cat /tmp/hhvm.log
  - sudo cat /var/log/apache2/error.log
  - sudo cat /var/log/apache2/access.log
  - sudo cat /var/log/apache2/other_vhosts_access.log

